#!/usr/bin/python

import os
import argparse
import string

from launcher.utilities.printer import Printer
from launcher.finder.finder import Finder
from launcher.runner import Runner
from launcher.configuration import Configuration

## Starting raiden launcher
## Defining application arguments
parser = argparse.ArgumentParser()
parser.add_argument("action", help="Define launcher action, can be run, stop, restart, clean, clean-image or rebuild")
parser.add_argument('images', nargs='*', help="List of targeted containers. if not defined, command will target all containers")
parser.add_argument("--verbose", "-v", type=int, help="Define log level from 0 (debug) to 3 (error only), default 1 (info)")
parser.add_argument("--pools", "-p", nargs='*', default=".", help="Define the container pool folder path")
parser.add_argument("--environement", "-e", type=str, help="Define environement to launch")
parser.add_argument("--log-path", type=str, help="Define where log should be written. No logging if not define")
parser.add_argument("--log-level", type=str, help="Define log level")
parser.add_argument("--log-name", default="raiden", type=str, help="Define logname. default raiden")
parser.add_argument("--force", "-f", help="For non removable containers force to be deleted", action='store_true')
parser.add_argument("--configuration", "-c", default="/etc/raiden/conf.yml", help="Define configuration file location")
arguments = parser.parse_args()

## Setting global printer
printer = Printer()
if arguments.verbose != None:
	printer.level = arguments.verbose

## Getting targeted services
targets = list(set(arguments.images)) if arguments.images else None

configuration = Configuration()

## Checking if there's a configuration file
## default configuration file path is /etc/raiden/conf.yml
if os.path.isfile(arguments.configuration):
	printer.debug("Raiden", "Loading configuration file " + arguments.configuration)
	configuration.loadFile(arguments.configuration)
else:
	printer.debug("Raiden", "No configuration file '" + arguments.configuration + "' to load")

## Command line arguments override configuration file
configuration.load(arguments.__dict__)

finder = Finder()

## adding targets to filter for dependency resolving
finder.targets = targets

## Do printer need to log ?
if arguments.log_path:
	printer.setLogger(configuration.log_file, arguments.log_level)

## Checking platform path
printer.debug("Raiden", "Pools : " + str(configuration.pools))
containers = finder.search(configuration.pools)

runner = Runner(configuration.environement, arguments.force)
if not runner.run(containers, arguments.action):
	printer.info("Raiden", "Done !")
else:
	printer.warning("Raiden", "There has been some errors during execution, your plateform can be unstable")
	exit(1)